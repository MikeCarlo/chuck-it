<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chuck It! | AI Chuck Norris Joke Generator</title>
  <meta name="description" content="Generate hilarious AI-powered Chuck Norris jokes with custom images. 100% in-browser, no API keys needed!">
  <meta name="keywords" content="Chuck Norris, jokes, meme generator, AI, Walker Texas Ranger, funny, WebLLM, browser AI">
  <meta property="og:title" content="Chuck It! - AI Chuck Norris Joke Generator">
  <meta property="og:description" content="Generate hilarious AI-powered Chuck Norris jokes with custom images. Runs entirely in your browser!">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Bebas+Neue&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      font-family: 'Oswald', sans-serif;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
      background: #1a0a00;
    }

    .video-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -2;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(26, 10, 0, 0.8);
      pointer-events: none;
      z-index: -1;
    }

    .container {
      max-width: 900px;
      width: 100%;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(3rem, 10vw, 6rem);
      color: #ffd700;
      text-shadow: 3px 3px 0 #8b4513, 6px 6px 0 rgba(0,0,0,0.3);
      margin-bottom: 10px;
      letter-spacing: 4px;
    }

    .subtitle {
      font-size: 1.2rem;
      color: #d4a574;
      margin-bottom: 40px;
      text-transform: uppercase;
      letter-spacing: 3px;
    }

    .badge {
      display: inline-block;
      background: linear-gradient(180deg, #c9a227 0%, #8b6914 100%);
      padding: 8px 20px;
      border-radius: 50px;
      font-size: 0.9rem;
      color: #1a0a00;
      font-weight: 700;
      margin-bottom: 30px;
      border: 2px solid #ffd700;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }

    .browser-badge {
      display: inline-block;
      background: linear-gradient(180deg, #28a745 0%, #1e7e34 100%);
      padding: 6px 15px;
      border-radius: 50px;
      font-size: 0.8rem;
      color: #fff;
      font-weight: 700;
      margin-bottom: 20px;
      border: 2px solid #28a745;
    }

    .input-section {
      margin-bottom: 30px;
    }

    .topic-input {
      width: 100%;
      max-width: 500px;
      padding: 18px 25px;
      font-size: 1.2rem;
      font-family: 'Oswald', sans-serif;
      border: 3px solid #8b4513;
      border-radius: 10px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      text-align: center;
      outline: none;
      transition: all 0.3s ease;
    }

    .topic-input::placeholder {
      color: #a08060;
    }

    .topic-input:focus {
      border-color: #ffd700;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
    }

    .generate-btn {
      display: inline-block;
      margin-top: 20px;
      padding: 18px 50px;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.8rem;
      color: #1a0a00;
      background: linear-gradient(180deg, #ffd700 0%, #c9a227 50%, #8b6914 100%);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 3px;
      box-shadow: 0 6px 0 #5c4a1f, 0 10px 30px rgba(0,0,0,0.4);
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .generate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 0 #5c4a1f, 0 15px 40px rgba(0,0,0,0.5);
    }

    .generate-btn:active {
      transform: translateY(4px);
      box-shadow: 0 2px 0 #5c4a1f, 0 5px 20px rgba(0,0,0,0.3);
    }

    .generate-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .result-section {
      margin-top: 40px;
      display: none;
    }

    .result-section.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .image-container {
      position: relative;
      display: inline-block;
      max-width: 100%;
      border: 5px solid #8b4513;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 50px rgba(0,0,0,0.5), 0 0 30px rgba(255, 215, 0, 0.2);
    }

    .generated-image {
      max-width: 100%;
      width: 512px;
      height: 512px;
      display: block;
      object-fit: cover;
    }

    .joke-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px;
      background: transparent;
      cursor: ns-resize;
    }

    .joke-text {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(1.2rem, 4vw, 2rem);
      color: #fff;
      text-shadow: 2px 2px 4px #000, -2px -2px 4px #000, 2px -2px 4px #000, -2px 2px 4px #000;
      text-align: center;
      line-height: 1.4;
      max-width: 90%;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      user-select: none;
      padding: 10px 20px;
      background: rgba(0,0,0,0.4);
      border-radius: 8px;
      cursor: text;
      min-width: 200px;
      outline: none;
      border: 2px solid transparent;
    }

    .joke-text:focus {
      border: 2px dashed #ffd700;
      user-select: text;
    }

    .drag-hint {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
      pointer-events: none;
    }

    .cowboy-hat {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%) rotate(-5deg);
      font-size: 120px;
      z-index: 10;
      filter: drop-shadow(3px 3px 5px rgba(0,0,0,0.5));
      pointer-events: none;
      animation: hatBounce 0.5s ease-out;
    }

    @keyframes hatBounce {
      0% { top: -100px; opacity: 0; }
      60% { top: 0px; }
      80% { top: -10px; }
      100% { top: -20px; opacity: 1; }
    }

    .share-section {
      margin-top: 30px;
    }

    .share-title {
      font-size: 1.1rem;
      color: #d4a574;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .share-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .share-btn {
      padding: 12px 25px;
      font-family: 'Oswald', sans-serif;
      font-size: 1rem;
      border: 2px solid;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .share-btn.twitter {
      background: #1da1f2;
      border-color: #1da1f2;
      color: #fff;
    }

    .share-btn.facebook {
      background: #4267b2;
      border-color: #4267b2;
      color: #fff;
    }

    .share-btn.copy {
      background: transparent;
      border-color: #ffd700;
      color: #ffd700;
    }

    .share-btn.download {
      background: #28a745;
      border-color: #28a745;
      color: #fff;
    }

    .share-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }

    .loading {
      display: none;
      margin-top: 40px;
    }

    .loading.active {
      display: block;
    }

    .loading-text {
      font-size: 1.5rem;
      color: #ffd700;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(255, 215, 0, 0.3);
      border-top-color: #ffd700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .progress-container {
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
      background: rgba(0,0,0,0.5);
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #8b4513;
    }

    .progress-bar {
      height: 20px;
      background: linear-gradient(90deg, #ffd700, #c9a227);
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 0.9rem;
      color: #d4a574;
      margin-top: 10px;
    }

    .footer {
      margin-top: 50px;
      font-size: 0.9rem;
      color: #8b6914;
    }

    .footer a {
      color: #d4a574;
      text-decoration: none;
    }

    .footer a:hover {
      color: #ffd700;
    }

    .texas-star {
      font-size: 2rem;
      color: #ffd700;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    #memeCanvas {
      display: none;
    }

    .error-message {
      color: #ff6b6b;
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 0, 0, 0.1);
      border-radius: 10px;
      display: none;
    }

    .error-message.active {
      display: block;
    }

    .init-section {
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(0,0,0,0.4);
      border-radius: 10px;
      border: 1px solid #8b4513;
    }

    .init-btn {
      padding: 15px 40px;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.4rem;
      color: #fff;
      background: linear-gradient(180deg, #28a745 0%, #1e7e34 100%);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: all 0.2s ease;
    }

    .init-btn:hover {
      transform: scale(1.05);
    }

    .init-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .model-status {
      margin-top: 15px;
      font-size: 0.9rem;
      color: #d4a574;
    }

    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-dot.pending { background: #ffc107; }
    .status-dot.loading { background: #17a2b8; animation: pulse 1s infinite; }
    .status-dot.ready { background: #28a745; }
    .status-dot.error { background: #dc3545; }

    .warning-box {
      background: rgba(255, 193, 7, 0.2);
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 0.9rem;
      color: #ffc107;
    }
  </style>
</head>
<body>
  <video class="video-bg" autoplay muted loop playsinline>
    <source src="background.mp4" type="video/mp4">
  </video>
  <div class="container">
    <div class="texas-star" style="display: flex; justify-content: center; gap: 20px;">üî´<span style="display: inline-block; transform: scaleX(-1);">üî´</span></div>
    <h1>CHUCK IT!</h1>
    <p class="subtitle">AI-Powered Chuck Norris Joke Generator</p>
    <div class="badge">ü§† Walker, Texas Ranger Approved ü§†</div>
    <br>
    <div class="browser-badge">üß† 100% In-Browser AI - No API Keys Needed!</div>

    <div class="init-section" id="initSection">
      <div class="warning-box">
        ‚ö†Ô∏è First load downloads ~2GB of AI models. Requires a modern browser with WebGPU support (Chrome 113+, Edge 113+).
      </div>
      <button id="initBtn" class="init-btn">üöÄ Load AI Models</button>
      <div class="model-status" id="modelStatus">
        <p><span class="status-dot pending" id="llmDot"></span>Text AI: <span id="llmStatus">Not loaded</span></p>
        <p><span class="status-dot pending" id="sdDot"></span>Image AI: <span id="sdStatus">Not loaded</span></p>
      </div>
      <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <p class="progress-text" id="progressText"></p>
    </div>

    <div class="input-section" id="inputSection" style="display: none;">
      <input type="text" id="topicInput" class="topic-input" placeholder="Enter a topic (e.g., programming, pizza, golf...)" maxlength="50">
      <br>
      <button id="generateBtn" class="generate-btn">ü§† Chuck It! ü§†</button>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p class="loading-text" id="loadingText">Chuck Norris is thinking...</p>
    </div>

    <div class="error-message" id="errorMessage"></div>

    <div class="result-section" id="resultSection">
      <div class="image-container" id="imageContainer">
        <canvas id="generatedImage" class="generated-image" width="512" height="512"></canvas>
        <div class="cowboy-hat">ü§†</div>
        <div class="joke-overlay" id="jokeOverlay">
          <p class="joke-text" id="jokeText" contenteditable="true"></p>
          <span class="drag-hint">‚Üï Drag to move ‚Ä¢ Click text to edit</span>
        </div>
      </div>

      <div class="share-section">
        <p class="share-title">Share the Legend</p>
        <div class="share-buttons">
          <a href="#" class="share-btn twitter" id="shareTwitter">
            <span>ùïè</span> Tweet
          </a>
          <a href="#" class="share-btn facebook" id="shareFacebook">
            <span>f</span> Share
          </a>
          <button class="share-btn copy" id="copyJoke">
            <span>üìã</span> Copy Joke
          </button>
          <button class="share-btn download" id="downloadBtn">
            <span>‚¨áÔ∏è</span> Download
          </button>
        </div>
      </div>
    </div>

    <canvas id="memeCanvas"></canvas>

    <footer class="footer">
      <p>Chuck Norris doesn't need AI. AI needs Chuck Norris.</p>
      <p style="margin-top: 10px;">Built with roundhouse kicks by <a href="https://powerbi.tips" target="_blank">PowerBI.tips</a></p>
    </footer>
  </div>

  <!-- WebLLM -->
  <script type="module">
    import * as webllm from 'https://esm.run/@mlc-ai/web-llm';

    // Make it globally available
    window.webllm = webllm;
  </script>

  <script type="module">
    // State
    let llmEngine = null;
    let sdPipeline = null;
    let modelsReady = false;

    const initBtn = document.getElementById('initBtn');
    const initSection = document.getElementById('initSection');
    const inputSection = document.getElementById('inputSection');
    const topicInput = document.getElementById('topicInput');
    const generateBtn = document.getElementById('generateBtn');
    const loading = document.getElementById('loading');
    const loadingText = document.getElementById('loadingText');
    const resultSection = document.getElementById('resultSection');
    const generatedImage = document.getElementById('generatedImage');
    const jokeText = document.getElementById('jokeText');
    const errorMessage = document.getElementById('errorMessage');
    const canvas = document.getElementById('memeCanvas');
    const ctx = canvas.getContext('2d');
    const progressBar = document.getElementById('progressBar');
    const progressContainer = document.getElementById('progressContainer');
    const progressText = document.getElementById('progressText');
    const llmDot = document.getElementById('llmDot');
    const sdDot = document.getElementById('sdDot');
    const llmStatus = document.getElementById('llmStatus');
    const sdStatus = document.getElementById('sdStatus');

    const loadingMessages = [
      "Chuck Norris is thinking...",
      "Roundhouse kicking the neurons...",
      "Chuck Norris counted to infinity. Twice.",
      "Loading at the speed of Chuck...",
      "Generating pure awesomeness...",
      "Walker, Texas Ranger is on the case..."
    ];

    let loadingInterval;

    function showLoading(message) {
      loading.classList.add('active');
      resultSection.classList.remove('active');
      errorMessage.classList.remove('active');
      generateBtn.disabled = true;
      loadingText.textContent = message || loadingMessages[0];
      
      let i = 0;
      loadingInterval = setInterval(() => {
        loadingText.textContent = loadingMessages[i % loadingMessages.length];
        i++;
      }, 2000);
    }

    function hideLoading() {
      loading.classList.remove('active');
      generateBtn.disabled = false;
      clearInterval(loadingInterval);
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('active');
      hideLoading();
    }

    function updateProgress(percent, text) {
      progressBar.style.width = percent + '%';
      progressText.textContent = text;
    }

    // Initialize models
    initBtn.addEventListener('click', async () => {
      initBtn.disabled = true;
      initBtn.textContent = '‚è≥ Loading...';
      progressContainer.style.display = 'block';

      try {
        // Load WebLLM
        llmDot.className = 'status-dot loading';
        llmStatus.textContent = 'Loading...';
        updateProgress(10, 'Loading text AI model...');

        const webllm = window.webllm;
        
        llmEngine = await webllm.CreateMLCEngine('Phi-3.5-mini-instruct-q4f16_1-MLC', {
          initProgressCallback: (progress) => {
            const pct = Math.round(progress.progress * 40) + 10;
            updateProgress(pct, `Loading text AI: ${Math.round(progress.progress * 100)}%`);
          }
        });

        llmDot.className = 'status-dot ready';
        llmStatus.textContent = 'Ready! (Phi-3.5-mini)';
        updateProgress(50, 'Text AI loaded!');

        // For image generation, we'll use a placeholder approach
        // Full SD in browser is very slow - instead use pre-made Chuck images
        sdDot.className = 'status-dot ready';
        sdStatus.textContent = 'Using preset images (faster)';
        updateProgress(100, 'All models ready!');

        modelsReady = true;
        
        setTimeout(() => {
          initSection.style.display = 'none';
          inputSection.style.display = 'block';
        }, 1000);

      } catch (error) {
        console.error('Model loading error:', error);
        showError('Failed to load AI models. Make sure you have WebGPU support (Chrome 113+ or Edge 113+). Error: ' + error.message);
        initBtn.disabled = false;
        initBtn.textContent = 'üöÄ Try Again';
        llmDot.className = 'status-dot error';
        llmStatus.textContent = 'Failed';
      }
    });

    // Chuck Norris images (public domain / creative commons) - laughing people
    const chuckImages = [
      'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=512&h=512&fit=crop&q=80', // laughing man
      'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=512&h=512&fit=crop&q=80', // smiling guy
      'https://images.unsplash.com/photo-1539571696357-5a69c17a67c6?w=512&h=512&fit=crop&q=80', // laughing young man
      'https://images.unsplash.com/photo-1488161628813-04466f872be2?w=512&h=512&fit=crop&q=80', // happy laughing
      'https://images.unsplash.com/photo-1552058544-f2b08422138a?w=512&h=512&fit=crop&q=80', // guy laughing
      'https://images.unsplash.com/photo-1517849845537-4d257902454a?w=512&h=512&fit=crop&q=80', // laughing expression
      'https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?w=512&h=512&fit=crop&q=80', // woman laughing
      'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=512&h=512&fit=crop&q=80', // happy woman
      'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=512&h=512&fit=crop&q=80', // laughing portrait
    ];

    async function generateJoke(topic) {
      const prompt = `Create ONE Chuck Norris joke about "${topic}". One sentence only. No explanations, notes, or commentary. Just the joke.`;
      
      const response = await llmEngine.chat.completions.create({
        messages: [{ role: 'user', content: prompt }],
        max_tokens: 50,
        temperature: 0.9,
      });

      // Strip any notes or explanations
      let joke = response.choices[0].message.content.trim();
      // Remove anything after (Note: or similar
      joke = joke.split(/\s*\(Note:/i)[0].trim();
      joke = joke.split(/\s*Note:/i)[0].trim();
      // Remove quotes if wrapped
      joke = joke.replace(/^["']|["']$/g, '');
      
      return joke;
    }

    function getRandomChuckImage() {
      return chuckImages[Math.floor(Math.random() * chuckImages.length)];
    }

    async function handleGenerate() {
      if (!modelsReady) {
        showError('Please load the AI models first!');
        return;
      }

      const topic = topicInput.value.trim() || 'being awesome';
      showLoading('Generating Chuck Norris wisdom...');

      try {
        // Generate joke
        loadingText.textContent = 'Chuck Norris is crafting a joke...';
        const joke = await generateJoke(topic);

        // Get random image
        loadingText.textContent = 'Summoning Chuck Norris...';
        const imageUrl = getRandomChuckImage();

        // Load and draw image
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        img.onload = () => {
          const imgCanvas = generatedImage;
          const imgCtx = imgCanvas.getContext('2d');
          imgCtx.drawImage(img, 0, 0, 512, 512);
          
          jokeText.textContent = joke + ' - Chuck Norris';
          textYPercent = 50; // Reset to center
          updateTextPosition();
          hideLoading();
          resultSection.classList.add('active');

          // Update share links
          const shareText = encodeURIComponent(`${joke} ü§† #ChuckNorris #ChuckIt`);
          const shareUrl = encodeURIComponent(window.location.href);
          
          document.getElementById('shareTwitter').href = 
            `https://twitter.com/intent/tweet?text=${shareText}&url=${shareUrl}`;
          document.getElementById('shareFacebook').href = 
            `https://www.facebook.com/sharer/sharer.php?u=${shareUrl}&quote=${shareText}`;
        };

        img.onerror = () => {
          showError('Failed to load image');
        };

        img.src = imageUrl;

      } catch (error) {
        console.error('Generation error:', error);
        showError('Failed to generate: ' + error.message);
      }
    }

    generateBtn.addEventListener('click', handleGenerate);

    topicInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleGenerate();
      }
    });

    // Draggable text position
    let textYPercent = 50; // default center (0-100)
    const jokeOverlay = document.getElementById('jokeOverlay');
    let isDragging = false;
    let startY = 0;
    let startPercent = 0;

    function updateTextPosition() {
      jokeText.style.top = textYPercent + '%';
      jokeText.style.transform = 'translateX(-50%) translateY(-50%)';
    }

    jokeOverlay.addEventListener('mousedown', (e) => {
      // Don't drag if clicking on the text to edit
      if (e.target === jokeText) return;
      isDragging = true;
      startY = e.clientY;
      startPercent = textYPercent;
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const rect = jokeOverlay.getBoundingClientRect();
      const deltaY = e.clientY - startY;
      const deltaPercent = (deltaY / rect.height) * 100;
      textYPercent = Math.max(10, Math.min(90, startPercent + deltaPercent));
      updateTextPosition();
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
    });

    // Touch support
    jokeOverlay.addEventListener('touchstart', (e) => {
      // Don't drag if touching the text to edit
      if (e.target === jokeText) return;
      isDragging = true;
      startY = e.touches[0].clientY;
      startPercent = textYPercent;
    });

    document.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      const rect = jokeOverlay.getBoundingClientRect();
      const deltaY = e.touches[0].clientY - startY;
      const deltaPercent = (deltaY / rect.height) * 100;
      textYPercent = Math.max(10, Math.min(90, startPercent + deltaPercent));
      updateTextPosition();
    });

    document.addEventListener('touchend', () => {
      isDragging = false;
    });

    // Copy joke
    document.getElementById('copyJoke').addEventListener('click', async () => {
      const joke = jokeText.textContent;
      try {
        await navigator.clipboard.writeText(joke);
        const btn = document.getElementById('copyJoke');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span>‚úì</span> Copied!';
        setTimeout(() => {
          btn.innerHTML = originalText;
        }, 2000);
      } catch (err) {
        showError('Failed to copy joke');
      }
    });

    // Download meme
    document.getElementById('downloadBtn').addEventListener('click', () => {
      const srcCanvas = generatedImage;
      const joke = jokeText.textContent;

      canvas.width = 512;
      canvas.height = 512;

      // Draw image
      ctx.drawImage(srcCanvas, 0, 0);

      // Draw cowboy hat emoji at top
      ctx.font = '120px serif';
      ctx.textAlign = 'center';
      ctx.save();
      ctx.translate(canvas.width / 2, 60);
      ctx.rotate(-5 * Math.PI / 180);
      ctx.fillText('ü§†', 0, 0);
      ctx.restore();

      // Add dark overlay behind text area
      ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Add text
      ctx.font = 'bold 32px "Bebas Neue", sans-serif';
      ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      // Text shadow
      ctx.shadowColor = '#000';
      ctx.shadowBlur = 6;
      ctx.shadowOffsetX = 2;
      ctx.shadowOffsetY = 2;

      // Word wrap
      const maxWidth = canvas.width - 60;
      const words = joke.split(' ');
      let lines = [];
      let currentLine = '';

      words.forEach(word => {
        const testLine = currentLine + word + ' ';
        const metrics = ctx.measureText(testLine);
        if (metrics.width > maxWidth && currentLine !== '') {
          lines.push(currentLine.trim());
          currentLine = word + ' ';
        } else {
          currentLine = testLine;
        }
      });
      lines.push(currentLine.trim());

      const lineHeight = 40;
      // Use the dragged position
      const centerY = (textYPercent / 100) * canvas.height;
      const startY = centerY - (lines.length - 1) * lineHeight / 2;

      lines.forEach((line, i) => {
        ctx.fillText(line, canvas.width / 2, startY + i * lineHeight);
      });

      // Download
      const link = document.createElement('a');
      link.download = 'chuck-norris-joke.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });
  </script>
</body>
</html>
